# Requirements Document

## Introduction

Данная фича представляет собой создание простого Node.js сервера-обертки над существующим модулем llm_rotation.ts. Сервер должен предоставлять REST API эндпоинт `/v1/chat/completions`, совместимый с OpenAI API, который будет автоматически маршрутизировать запросы к соответствующим LLM провайдерам на основе указанной модели.

## Requirements

### Requirement 1

**User Story:** Как разработчик, я хочу иметь единый HTTP эндпоинт для работы с различными LLM провайдерами, чтобы не управлять множеством различных API интерфейсов.

#### Acceptance Criteria

1. WHEN пользователь отправляет POST запрос на `/v1/chat/completions` THEN сервер SHALL принять запрос в формате OpenAI API
2. WHEN в запросе указана модель THEN сервер SHALL автоматически определить соответствующего провайдера
3. WHEN запрос обработан успешно THEN сервер SHALL вернуть ответ в формате OpenAI API
4. WHEN происходит ошибка THEN сервер SHALL вернуть структурированный ответ об ошибке

### Requirement 2

**User Story:** Как администратор системы, я хочу использовать умную систему ротации API ключей с автоматическим переключением и отслеживанием статуса, чтобы обеспечить высокую доступность и равномерное распределение нагрузки.

#### Acceptance Criteria

1. WHEN сервер запускается THEN он SHALL читать API ключи из переменных окружения (поддерживая массивы ключей)
2. WHEN API ключ работает успешно THEN система SHALL автоматически переключиться на следующий ключ для равномерного распределения
3. WHEN API ключ не работает THEN система SHALL автоматически попробовать следующий доступный ключ
4. WHEN ключ достигает лимита запросов THEN система SHALL пометить его как 'rate-limited' и пропустить
5. WHEN все ключи провайдера исчерпаны THEN система SHALL вернуть детальную ошибку с информацией о статусе ключей
6. WHEN запрашивается статус ключей THEN система SHALL предоставить актуальную информацию ('untested', 'working', 'failed', 'rate-limited')
этот функционал уже есть в классе llm_rotation.ts

### Requirement 3

**User Story:** Как клиент API, я хочу получать список доступных моделей, чтобы знать какие модели я могу использовать.

#### Acceptance Criteria

1. WHEN пользователь отправляет GET запрос на `/v1/models` THEN сервер SHALL вернуть список всех доступных моделей
2. WHEN модель принадлежит определенному провайдеру THEN в ответе SHALL быть указан соответствующий провайдер
3. WHEN ответ формируется THEN он SHALL быть совместим с форматом OpenAI API

### Requirement 4

**User Story:** Как DevOps инженер, я хочу мониторить состояние сервера, чтобы обеспечить его стабильную работу.

#### Acceptance Criteria

1. WHEN пользователь отправляет GET запрос на `/health` THEN сервер SHALL вернуть статус работоспособности
2. WHEN сервер работает нормально THEN health check SHALL возвращать статус 200 OK
3. WHEN происходят ошибки THEN они SHALL логироваться в консоль

### Requirement 5

**User Story:** Как разработчик клиентского приложения, я хочу получать корректные параметры использования токенов, чтобы отслеживать расходы на API вызовы.

#### Acceptance Criteria

1. WHEN запрос обрабатывается THEN ответ SHALL содержать информацию об использованных токенах
2. WHEN подсчитываются токены THEN система SHALL предоставить приблизительную оценку
3. WHEN формируется ответ THEN usage информация SHALL быть в формате OpenAI API

### Requirement 6

**User Story:** Как пользователь API, я хочу передавать стандартные параметры генерации (temperature, max_tokens, top_p), чтобы контролировать поведение модели.

#### Acceptance Criteria

1. WHEN в запросе указаны параметры генерации THEN они SHALL передаваться в соответствующий провайдер
2. WHEN параметры не указаны THEN SHALL использоваться значения по умолчанию
3. WHEN параметр не поддерживается провайдером THEN он SHALL игнорироваться без ошибки

### Requirement 7

**User Story:** Как разработчик, я хочу получать доступ к статистике использования API ключей, чтобы мониторить их состояние и планировать ротацию.

#### Acceptance Criteria

1. WHEN запрашивается эндпоинт статуса THEN сервер SHALL предоставить информацию о состоянии всех API ключей
2. WHEN ключ меняет статус THEN изменение SHALL быть отражено в реальном времени
3. WHEN происходит ротация ключей THEN система SHALL логировать переключения для отладки